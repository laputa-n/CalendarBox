name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          [ -n "${{ secrets.EC2_HOST }}" ] || { echo "❌ EC2_HOST secret missing"; exit 1; }
          [ -n "${{ secrets.EC2_USER }}" ] || { echo "❌ EC2_USER secret missing"; exit 1; }
          [ -n "${{ secrets.EC2_SSH_KEY }}" ] || { echo "❌ EC2_SSH_KEY secret missing"; exit 1; }
          echo "✅ all required secrets exist"

      - name: Setup SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s" "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # ✅ 프론트는 Actions에서 빌드 (EC2에서 node 안 돌림)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Build frontend on GitHub Actions
        working-directory: apps/frontend
        env:
          GENERATE_SOURCEMAP: "false"
        run: |
          set -euo pipefail
          npm ci --no-audit --progress=false
          npm run build

      # ✅ build/ 산출물만 EC2로 전송
      - name: Sync frontend build to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30" \
            apps/frontend/build/ \
            "$EC2_USER@$EC2_HOST:/var/www/calendarbox/"

      # ✅ 나머지(백엔드/ML)는 서버에서 기존대로 처리
      - name: Run deploy.sh on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail
          ssh \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o ConnectTimeout=30 \
            "$EC2_USER@$EC2_HOST" \
            'bash -lc "
              set -euo pipefail
              /srv/calendarbox/deploy.sh
            "'
